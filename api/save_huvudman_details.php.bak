<?php
// api/save_huvudman_details.php

// SÄKERSTÄLLER KORREKTA SÖKVÄGAR OCH INKLUDERINGAR
require_once __DIR__ . '/auth_check.php';
require_once __DIR__ . '/db_connect.php';

header('Content-Type: application/json; charset=utf-8');
header('Cache-Control: no-cache, must-revalidate');

$response = ['success' => false, 'message' => 'Ett okänt fel inträffade.'];

// TRY-CATCH FÖR ATT FÅNGA ALLA FEL
try {
    // Använder din befintliga funktion för databasanslutning
    $pdo = get_db_connection();

    // Kontrollera att det är en POST-förfrågan
    if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
        throw new Exception('Endast POST-metoden är tillåten.');
    }

    // Hämta och validera personnummer från POST-data
    if (!isset($_POST['Personnummer']) || empty($_POST['Personnummer'])) {
        http_response_code(400);
        $response['message'] = 'Inget personnummer angivet i datan.';
        echo json_encode($response);
        exit;
    }
    $pnr = $_POST['Personnummer'];

    // Din kompletta vitlista över tillåtna fält att uppdatera
    $WHITELIST = [
        'PERSONNUMMER', 'FORNAMN', 'EFTERNAMN', 'HELT_NAMN', 'ADRESS', 'POSTNUMMER', 'ORT', 'VISTELSEADRESS',
        'VISTELSEPOSTNR', 'VISTELSEORT', 'TELEFON', 'MOBIL', 'EPOST', 'MEDBORGARSKAP', 'CIVILSTAND', 'SAMMANBOENDE',
        'MEDSOKANDE_FORNAMN', 'MEDSOKANDE_EFTERNAMN', 'MEDSOKANDE_PERSONNUMMER', 'MEDSOKANDE_MEDBORGARSKAP',
        'MEDSOKANDE_CIVILSTAND', 'MEDSOKANDE_SYSSELSATTNING', 'CLEARINGNUMMER', 'KONTONUMMER', 'BANKNAMN',
        'OVERFORMYNDARE_ID', 'BOENDE_NAMN', 'BOSTAD_TYP', 'BOSTAD_ANTAL_RUM', 'BOSTAD_ANTAL_BOENDE',
        'BOSTAD_KONTRAKTSTID', 'SYSSELSATTNING', 'INKOMSTTYP', 'DEKLARERAT_STATUS', 'ARVODE_UTBETALT_STATUS',
        'MERKOSTNADSERSTATTNING_STATUS', 'ARSR_OVRIGA_UPPLYSNINGAR', 'ERSATTNING_ANNAN_MYNDIGHET_STATUS',
        'ERSATTNING_ANNAN_MYNDIGHET_FRAN', 'HYRA', 'EL_KOSTNAD', 'FACK_AVGIFT_AKASSA', 'RESKOSTNADER', 'HEMFORSAKRING',
        'MEDICIN_KOSTNAD', 'LAKARVARDSKOSTNAD', 'BARNOMSORG_AVGIFT', 'FARDTJANST_AVGIFT', 'AKUT_TANDVARDSKOSTNAD',
        'BREDBAND', 'OVRIG_KOSTNAD_BESKRIVNING', 'OVRIG_KOSTNAD_BELOPP', 'ARBETSLOSHETSERSTATTNING',
        'AVTALSFOrSAKRING_AFA', 'BARNBIDRAG_STUDIEBIDRAG', 'BOSTADSBIDRAG', 'ETABLERINGSERSATTNING', 'BARNS_INKOMST',
        'HYRESINTAKT_INNEBOENDE', 'LON', 'PENSION_LIVRANTA_SJUK_AKTIVITET', 'SJUKPENNING_FORALDRAPENNING',
        'SKATTEATERBARING', 'STUDIEMEDEL', 'UNDERHALLSSTOD_EFTERLEVANDEPENSION', 'VANTAD_INKOMST_BESKRIVNING',
        'VANTAD_INKOMST_BELOPP', 'OVRIG_INKOMST_BESKRIVNING', 'OVRIG_INKOMST_BELOPP', 'TILLGANG_BANKMEDEL_VARDE',
        'TILLGANG_BOSTADSRATT_FASTIGHET_VARDE', 'TILLGANG_FORDON_MM_VARDE', 'SKULD_KFM_VARDE', 'FORORDNANDE_DATUM',
        'SALDO_RAKNINGSKONTO_FORORDNANDE', 'HANDLAGGARE', 'KontaktpersonNamn', 'KontaktpersonTel', 'HANDLAGGARE_LSS',
        'HANDLAGGARE_SOCIAL', 'HYRESVARD_NAMN', 'BUDGET_INKOMSTER_NETTO_MANAD', 'BUDGET_UTGIFTER_VERIFIERADE_MANAD',
        'BUDGET_RESULTAT_MANAD', 'FickpengTotalVecka', 'FickpengMondag', 'FickpengTisdag', 'FickpengOnsdag',
        'FickpengTorsdag', 'FickpengFredag', 'KFM_SKULDFORANDRING', 'KFM_LAST_CHECKED_AT', 'KFM_CASE_NO', 'KFM_STATUS',
        'OVERFORMYNDAR_NAMN', 'BoendeKontaktpersonNamn', 'BoendeKontaktpersonTel', 'Omsorgsavgift', 'FickpengarManad',
        'PensionLeverantor', 'BostadsbidragLeverantor', 'HyraLeverantor', 'Omsorgsavgiftleverantor', 'ElLeverantor',
        'HemforsakringLeverantor', 'LakarvardskostnadLeverantor', 'MedicinLeverantor', 'BredbandLeverantor', 'FickpengarLeverantor'
    ];

    $fields = [];
    $params = [];

    // KORRIGERING: Läs från $_POST istället för en JSON-payload
    // Detta matchar hur FormData från JavaScript skickar data.
    foreach ($_POST as $key => $val) {
        // Kontrollera att fältet finns i vitlistan
        if (in_array($key, $WHITELIST, true)) {
            $paramName = ':' . $key;
            // Använd backticks ` för att skydda kolumnnamn
            $fields[] = "`$key` = $paramName";
            // Hantera tomma strängar som NULL för databasen
            $params[$paramName] = ($val === '' || $val === null) ? null : $val;
        }
    }

    if (empty($fields)) {
        echo json_encode(['success' => true, 'message' => 'Inga fält som matchade vitlistan skickades för att sparas.']);
        exit;
    }
    
    // Bygg och förbered SQL-frågan
    $sql = "UPDATE huvudman SET " . implode(', ', $fields) . " WHERE Personnummer = :Personnummer_WHERE";
    $stmt = $pdo->prepare($sql);

    // Lägg till personnumret för WHERE-klausulen
    $params[':Personnummer_WHERE'] = $pnr;
    
    // Exekvera och skicka svar
    if ($stmt->execute($params)) {
        $response['success'] = true;
        $response['message'] = 'Huvudmannens uppgifter har sparats.';
    } else {
        $errorInfo = $stmt->errorInfo();
        throw new Exception('Det gick inte att spara uppgifterna i databasen. Fel: ' . ($errorInfo[2] ?? 'Okänt fel'));
    }

} catch (PDOException $e) {
    http_response_code(500);
    error_log("Databasfel i save_huvudman_details.php: " . $e->getMessage());
    $response = ['success' => false, 'message' => 'Databasfel: ' . $e->getMessage()];
} catch (Exception $e) {
    http_response_code(500);
    error_log("Generellt fel i save_huvudman_details.php: " . $e->getMessage());
    $response = ['success' => false, 'message' => 'Fel: ' . $e->getMessage()];
}

echo json_encode($response);
?>